{% extends 'base.html' %}

{% block title %}Admin â€” Dashboard{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">Admin Dashboard</h1>
    <small class="text-muted">Overview of cookie activity & recent annotations</small>
  </div>
  <div class="d-flex align-items-center">
    <div class="me-3 text-end">
      <div><span class="badge bg-primary">Cookies: {{ stats.cookie_count }}</span></div>
      <div class="mt-1"><span class="badge bg-success">Annotations: {{ stats.annotation_count }}</span></div>
    </div>
    <a href="{{ url_for('routes.admin_logout') }}" class="btn btn-sm btn-outline-secondary">Logout</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex flex-column p-3">
        <div class="mb-3">
          <div class="input-group">
            <span class="input-group-text">ðŸ”Ž</span>
            <input id="adminSearch" class="form-control" placeholder="Search annotations, user ids, agents..." aria-label="Search" />
            <button id="clearSearch" class="btn btn-outline-secondary" title="Clear">Clear</button>
          </div>
          <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="onlyWithUser">
            <label class="form-check-label" for="onlyWithUser">Only show annotations with user_id</label>
          </div>
        </div>

        <h6 class="mb-2">Cookie Records</h6>
        <div class="list-group list-group-flush overflow-auto" style="max-height:54vh;">
          {% if records %}
            {% for r in records %}
              <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-start show-cookie" data-user_id="{{ r.user_id or '' }}" data-user_agent="{{ r.user_agent|e }}" data-fingerprint="{{ r.fingerprint_hash or '' }}">
                <div class="ms-2 me-auto">
                  <div class="fw-semibold">{{ (r.user_id[:6] + '...') if r.user_id else '(no id)' }}</div>
                  <small class="text-muted">Last: {{ r.last_seen or r.created_at }}</small>
                </div>
                <div class="text-end">
                  <div><span class="badge bg-info">{{ r.views or 0 }} views</span></div>
                  <div class="mt-1"><span class="badge bg-warning text-dark">{{ r.annotations_count or 0 }} ann</span></div>
                </div>
              </a>
            {% endfor %}
          {% else %}
            <div class="text-muted px-3">No cookie records available.</div>
          {% endif %}
        </div>

        <div class="mt-auto pt-3 small text-muted">
          Tip: click a user to view full cookie details (agent & fingerprint).
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-body p-3 d-flex flex-column">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Recent Annotations</h6>
          <small class="text-muted">Showing up to {{ annotations|length }} entries</small>
        </div>

        <div class="table-responsive" style="max-height:68vh; overflow:auto;">
          {% if annotations %}
            <table class="table table-hover table-sm align-middle mb-0">
              <thead class="table-light position-sticky" style="top:0; z-index:1">
                <tr>
                  <th scope="col">When</th>
                  <th scope="col">Date</th>
                  <th scope="col">Area</th>
                  <th scope="col">Author</th>
                  <th scope="col">User</th>
                  <th scope="col">Text</th>
                  <th scope="col" class="text-end">+ / -</th>
                </tr>
              </thead>
              <tbody>
                {% for a in annotations %}
                  <tr>
                    <td class="text-nowrap"><small class="text-muted">{{ a.created_at }}</small></td>
                    <td class="text-nowrap">{{ a.date }}</td>
                    <td>{{ a.area }}</td>
                    <td>{{ a.author or 'anonymous' }}</td>
                    <td>
                      {% if a.user_id %}
                        <button class="btn btn-sm btn-outline-secondary show-cookie" data-user_id="{{ a.user_id }}" data-user_agent="" data-fingerprint="">{{ a.user_id[:6] }}â€¦</button>
                      {% else %}
                        <span class="text-muted">â€”</span>
                      {% endif %}
                    </td>
                    <td style="max-width:36ch; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">{{ a.text }}</td>
                    <td class="text-end"><span class="badge bg-success me-1">{{ a.likes or 0 }}</span><span class="badge bg-danger">{{ a.dislikes or 0 }}</span></td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}
            <div class="text-muted">No annotations found.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
  {{ super() }}
  <script>
    (function(){
      const search = document.getElementById('adminSearch');
      const clearBtn = document.getElementById('clearSearch');
      const onlyWithUser = document.getElementById('onlyWithUser');

      function matchText(el, q){
        if(!q) return true;
        q = q.toLowerCase();
        return (el.textContent||'').toLowerCase().includes(q);
      }

      function filterList(){
        const q = (search.value||'').trim();
        // filter annotations rows
        document.querySelectorAll('table tbody tr').forEach(r => {
          const text = r.textContent || '';
          const hasUser = !!(r.querySelector('button.show-cookie') || r.querySelector('.show-cookie'));
          const ok = (!q || text.toLowerCase().includes(q.toLowerCase())) && (!onlyWithUser.checked || hasUser);
          r.style.display = ok ? '' : 'none';
        });
        // filter cookie list
        document.querySelectorAll('.list-group .list-group-item').forEach(item => {
          const ok = !q || (item.textContent||'').toLowerCase().includes(q.toLowerCase());
          item.style.display = ok ? '' : 'none';
        });
      }

      if(search) search.addEventListener('input', filterList);
      if(clearBtn) clearBtn.addEventListener('click', e => { e.preventDefault(); search.value=''; filterList(); });
      if(onlyWithUser) onlyWithUser.addEventListener('change', filterList);

      // cookie modal (simple, non-blocking)
      function showCookieDetail(e){
        e.preventDefault();
        const el = e.currentTarget;
        const uid = el.dataset.user_id || '';
        const ua = el.dataset.user_agent || '';
        const fp = el.dataset.fingerprint || '';

        const container = document.createElement('div');
        container.innerHTML = `
          <div class="modal fade show" tabindex="-1" style="display:block; background:rgba(0,0,0,0.4);">
            <div class="modal-dialog modal-lg modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Cookie details â€” ${uid || 'anonymous'}</h5>
                  <button type="button" class="btn-close" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p><strong>User agent</strong></p>
                  <pre style="white-space:pre-wrap; word-break:break-word;">${ua || '(not available)'}</pre>
                  <p class="mt-3"><strong>Fingerprint</strong></p>
                  <pre style="word-break:break-all;">${fp || '(not available)'}</pre>
                </div>
                <div class="modal-footer"><button class="btn btn-secondary close-modal">Close</button></div>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(container);
        function cleanup(){ container.remove(); }
        container.querySelectorAll('.close-modal, .btn-close').forEach(b => b.addEventListener('click', cleanup));
      }

      document.querySelectorAll('.show-cookie').forEach(el => el.addEventListener('click', showCookieDetail));
    })();
  </script>
{% endblock %}
